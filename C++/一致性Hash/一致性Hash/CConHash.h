#include "CNode_s.h"
#include "CHashFun.h"
#include "CVirtualNode_s.h"
#include "util_rbtree.h"

#define _NULL(rbtree) (&((rbtree)->null))

class CConHash
{
public:
	/*构造函数*/
	CConHash(CHashFun * pFunc);

	/*设置hash函数*/
	void setFunc(CHashFun * pFunc);

	/*增加实体结点 , 0代表成功 , -1代表失败*/
	int addNode_s(CNode_s * pNode);

	/*删除实体结点 , 0代表成功 , -1代表失败*/
	int delNode_s(CNode_s * pNode);

	/*查找实体结点*/
	CNode_s * lookupNode_s(const char * object);

	/*获取一致性hash结构的所有虚拟结点数量*/
	int getVNodes();
private:
	/*Hash函数*/
	CHashFun * func;
	/*虚拟结点总个数*/
	int vNodes;
	/*存储虚拟结点的红黑树*/
	util_rbtree_t * vnode_tree;
};
/*辅助函数，虚拟结点转化为红黑树结点*/
util_rbtree_node_t* util_rbtree_lookup(util_rbtree_t *rbtree, long key)
{
	if ((rbtree != NULL) && !util_rbtree_isempty(rbtree))
	{
		util_rbtree_node_t *node = NULL;
		util_rbtree_node_t *temp = rbtree->root;
		util_rbtree_node_t *null = _NULL(rbtree);
		while (temp != null)
		{
			if (key <= temp->key)
			{
				node = temp; /* update node */
				temp = temp->left;
			}
			else if (key > temp->key)
			{
				temp = temp->right;
			}
		}
		/* if node==NULL return the minimum node */
		return ((node != NULL) ? node : util_rbtree_min(rbtree));
	}
	return NULL;
}